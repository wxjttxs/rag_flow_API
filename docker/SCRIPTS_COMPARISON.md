# MySQL 脚本对比说明

## 📊 两个脚本的区别

### 1️⃣ `fix-mysql-disk.sh` - 临时清理脚本

**用途：** 紧急清理 binlog，快速释放空间

**适用场景：**
- ✅ 磁盘快满了，需要立即释放空间
- ✅ 不想停止服务
- ✅ 快速恢复系统功能

**操作内容：**
```bash
1. 连接到 MySQL
2. 清理 7 天前的 binlog 文件
3. 设置自动清理策略（7天）
4. 重启 RAGFlow 服务
```

**效果：**
- 释放空间：约 1-1.5GB
- 执行时间：5 分钟
- 服务中断：可选（可以不重启）

**缺点：**
- ⚠️ 只是临时方案
- ⚠️ 过几天可能还会满
- ⚠️ 数据仍在满载的根分区

---

### 2️⃣ `migrate-mysql-complete.sh` - 完整迁移脚本

**用途：** 彻底迁移 MySQL 数据到新磁盘

**适用场景：**
- ✅ 彻底解决磁盘空间问题
- ✅ 将数据移到更大的磁盘
- ✅ 长期稳定运行

**操作内容：**
```bash
1. 环境检查（权限、Docker、目标目录）
2. 停止 RAGFlow 服务
3. 创建新数据目录 /mnt/data6t/ragflow_mysql
4. 使用 rsync 迁移所有 MySQL 数据
5. 修复 docker-compose-base.yml 配置
6. 删除旧的 Docker volume
7. 启动服务
8. 验证迁移结果
```

**效果：**
- 释放空间：约 2.3GB（根分区）
- 执行时间：10-15 分钟（取决于数据量）
- 服务中断：约 5-10 分钟

**优点：**
- ✅ 彻底解决问题
- ✅ 数据在新磁盘（334GB 可用）
- ✅ 以后不用担心空间

---

## 🔄 脚本参考设计

`migrate-mysql-complete.sh` 完全参考了 `migrate-es-complete.sh` 的设计：

| 特性 | ES 迁移脚本 | MySQL 迁移脚本 |
|------|------------|----------------|
| **目标目录** | /mnt/data6t/ragflow_esdata | /mnt/data6t/ragflow_mysql |
| **配置文件** | docker-compose-base.yml | docker-compose-base.yml |
| **Volume 名称** | esdata01 | mysql_data |
| **数据迁移工具** | rsync | rsync |
| **权限设置** | 1000:1000 | 999:999 (MySQL UID) |
| **容器名称** | ragflow-es-01 | ragflow-mysql |
| **健康检查** | ES 集群状态 | MySQL 连接测试 |
| **特殊操作** | 调整水印/解除只读 | 无 |

---

## 📋 执行对比表

| 项目 | fix-mysql-disk.sh | migrate-mysql-complete.sh |
|------|-------------------|---------------------------|
| **解决程度** | 临时缓解 | 彻底解决 |
| **数据位置** | 不变（根分区） | 迁移到 /mnt/data6t |
| **释放空间** | 1-1.5GB | 2.3GB |
| **执行时间** | 5 分钟 | 10-15 分钟 |
| **服务中断** | 可选 | 必须（5-10分钟） |
| **风险等级** | 低 | 中等 |
| **需要备份** | 否 | 是（自动备份配置） |
| **可重复性** | 定期执行 | 一次性 |
| **长期效果** | 需要重复 | 永久有效 |

---

## 🎯 推荐执行策略

### 方案 A：保守策略（推荐新手）

```bash
# 第一步：紧急清理（立即）
sudo ./fix-mysql-disk.sh
# 测试是否恢复正常

# 第二步：准备迁移（1-2 天内）
# 观察系统运行情况
# 选择合适的时间窗口

# 第三步：完整迁移（计划维护时间）
sudo ./migrate-mysql-complete.sh
```

**优点：**
- 风险最低
- 有时间验证
- 可以回滚

---

### 方案 B：激进策略（推荐有经验用户）

```bash
# 直接执行完整迁移
sudo ./migrate-mysql-complete.sh
```

**优点：**
- 一步到位
- 节省时间
- 彻底解决

**前提：**
- 了解 Docker 和 MySQL
- 有备份或可以接受短暂中断
- 系统状态健康

---

## 📊 详细操作流程对比

### fix-mysql-disk.sh 流程

```mermaid
graph TD
    A[开始] --> B[检查权限]
    B --> C[显示当前 binlog]
    C --> D[用户确认]
    D --> E[连接 MySQL]
    E --> F[清理旧 binlog]
    F --> G[设置自动清理]
    G --> H[验证磁盘空间]
    H --> I[可选：重启服务]
    I --> J[完成]
```

**特点：** 快速、简单、无数据迁移

---

### migrate-mysql-complete.sh 流程

```mermaid
graph TD
    A[开始] --> B[环境检查]
    B --> C[显示磁盘状态]
    C --> D[用户确认]
    D --> E[停止服务]
    E --> F[创建新目录]
    F --> G[设置权限]
    G --> H[rsync 迁移数据]
    H --> I[备份配置文件]
    I --> J[修复 YAML 配置]
    J --> K[验证配置语法]
    K --> L[删除旧 volume]
    L --> M[启动服务]
    M --> N[等待 MySQL 启动]
    N --> O[验证迁移结果]
    O --> P[显示总结]
    P --> Q[完成]
```

**特点：** 完整、彻底、永久解决

---

## ⚠️ 关键区别总结

| 关键点 | fix-mysql-disk.sh | migrate-mysql-complete.sh |
|--------|-------------------|---------------------------|
| **问题定位** | 症状（binlog 过多） | 根因（磁盘位置不对） |
| **解决方式** | 清理数据 | 迁移位置 |
| **是否停服** | 否 | 是 |
| **配置修改** | 否 | 是 |
| **数据移动** | 否 | 是 |
| **永久性** | 临时 | 永久 |
| **复杂度** | 简单 | 复杂 |
| **参考脚本** | 无 | migrate-es-complete.sh |

---

## 🔍 如何选择？

### 选择 `fix-mysql-disk.sh` 如果：

- [ ] 现在是业务高峰期
- [ ] 没有维护时间窗口
- [ ] 只需要快速恢复
- [ ] 不熟悉 Docker 操作
- [ ] 数据不重要或有完整备份
- [ ] 计划后续再做迁移

### 选择 `migrate-mysql-complete.sh` 如果：

- [ ] 有维护时间窗口（10-15分钟）
- [ ] 想彻底解决问题
- [ ] 根分区经常满载
- [ ] 已经有 ES 迁移经验
- [ ] 追求长期稳定
- [ ] 不想频繁处理磁盘问题

---

## 💡 最佳实践建议

### 第一次处理这个问题？

```bash
# 1. 先用临时方案恢复
sudo ./fix-mysql-disk.sh

# 2. 测试系统是否正常
# 访问 UI，创建知识库，上传文档

# 3. 规划迁移时间
# 选择低峰期或周末

# 4. 执行完整迁移
sudo ./migrate-mysql-complete.sh
```

### 已经有 ES 迁移经验？

```bash
# 直接执行迁移
sudo ./migrate-mysql-complete.sh
```

---

## 📚 相关文档

- **MYSQL_DISK_ISSUE.md** - 问题诊断和解决方案
- **MIGRATION_COMPLETE.md** - ES 迁移总结（可参考）
- **ES_DISK_MIGRATION_GUIDE.md** - ES 迁移详细指南（方法类似）

---

## 🚀 快速决策树

```
磁盘满了，需要立即恢复吗？
├─ 是 → fix-mysql-disk.sh (临时清理)
│   └─ 恢复后，规划完整迁移
│
└─ 否，想彻底解决
    ├─ 有维护窗口？
    │   ├─ 是 → migrate-mysql-complete.sh (推荐)
    │   └─ 否 → 先 fix-mysql-disk.sh，后续再迁移
    │
    └─ 有 Docker 经验？
        ├─ 是 → migrate-mysql-complete.sh (直接上)
        └─ 否 → fix-mysql-disk.sh (稳妥)
```

---

## ✅ 总结

**fix-mysql-disk.sh**
- 🎯 目标：快速恢复
- ⏱️ 时间：5分钟
- 🔧 难度：简单
- 📊 效果：临时

**migrate-mysql-complete.sh**
- 🎯 目标：彻底解决
- ⏱️ 时间：10-15分钟
- 🔧 难度：中等
- 📊 效果：永久

**推荐：先清理，后迁移（稳妥）或直接迁移（高效）**



