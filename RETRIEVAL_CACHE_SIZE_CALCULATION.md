# 检索缓存空间占用计算

## 缓存配置
- **过期时间**: 6个月 (180天 = 15,552,000秒)
- **缓存前缀**: `retrieval_cache:`

## 单个缓存项大小估算

### 1. 缓存Key大小
- 前缀: `retrieval_cache:` (18字节)
- Hash值: xxhash.xxh64() 生成16字节十六进制字符串 (16字节)
- **Key总大小**: 约 34 字节

### 2. 缓存Value大小（检索结果）

根据代码分析，检索结果包含以下结构：

```json
{
  "chunks": [
    {
      "chunk_id": "uuid字符串",           // ~36字节
      "content_ltks": ["分词数组"],        // 平均 ~500-2000字节
      "content_with_weight": "内容文本",   // 平均 ~500-2000字节
      "doc_id": "uuid字符串",             // ~36字节
      "docnm_kwd": "文档名",              // 平均 ~50字节
      "kb_id": "uuid字符串",              // ~36字节
      "important_kwd": ["关键词数组"],     // 平均 ~100字节
      "image_id": "uuid字符串或空",        // ~36字节
      "similarity": 0.85,                 // ~8字节
      "vector_similarity": 0.82,          // ~8字节
      "term_similarity": 0.75,            // ~8字节
      "positions": [位置数组],             // 平均 ~50字节
      "doc_type_kwd": "文档类型",         // 平均 ~20字节
      "highlight": "高亮内容(可选)"        // 平均 ~500字节(如果启用)
    }
  ],
  "doc_aggs": [
    {
      "doc_name": "文档名",
      "doc_id": "uuid",
      "count": 5
    }
  ],
  "total": 100,
  "page": 1,
  "page_size": 30
}
```

#### 单个Chunk大小估算：
- **最小情况** (简单查询，无高亮): ~1,500 字节
- **平均情况** (正常查询): ~3,000 字节
- **最大情况** (复杂查询，启用高亮，大文本): ~8,000 字节

#### 单个检索结果大小估算：
- **默认page_size=30**: 
  - 最小: 30 × 1,500 + 元数据 ≈ 50 KB
  - 平均: 30 × 3,000 + 元数据 ≈ 100 KB
  - 最大: 30 × 8,000 + 元数据 ≈ 250 KB

- **最大page_size=1024**:
  - 最小: 1024 × 1,500 + 元数据 ≈ 1.5 MB
  - 平均: 1024 × 3,000 + 元数据 ≈ 3 MB
  - 最大: 1024 × 8,000 + 元数据 ≈ 8 MB

### 3. Redis内存开销
- Redis存储开销: 每个key-value对约额外占用 100-200 字节
- JSON序列化开销: 约增加 10-20%

## 空间占用计算

### 场景1: 中等使用量（保守估算）
- **假设条件**:
  - 每天1000次唯一查询
  - 平均每个结果100 KB
  - 缓存6个月

- **计算**:
  - 6个月总查询数: 1000 × 180 = 180,000 次
  - 单条缓存大小: 100 KB × 1.2 (开销) = 120 KB
  - 总缓存大小: 180,000 × 120 KB = 21,600,000 KB ≈ **20.6 GB**

### 场景2: 高使用量（实际估算）
- **假设条件**:
  - 每天5000次唯一查询
  - 平均每个结果150 KB
  - 缓存6个月

- **计算**:
  - 6个月总查询数: 5000 × 180 = 900,000 次
  - 单条缓存大小: 150 KB × 1.2 = 180 KB
  - 总缓存大小: 900,000 × 180 KB = 162,000,000 KB ≈ **154.4 GB**

### 场景3: 极高使用量（上限估算）
- **假设条件**:
  - 每天20000次唯一查询
  - 平均每个结果200 KB
  - 缓存6个月

- **计算**:
  - 6个月总查询数: 20000 × 180 = 3,600,000 次
  - 单条缓存大小: 200 KB × 1.2 = 240 KB
  - 总缓存大小: 3,600,000 × 240 KB = 864,000,000 KB ≈ **823.9 GB**

## Redis配置建议

### 当前Redis配置（docker-compose-base.yml）
```yaml
command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 128mb --maxmemory-policy allkeys-lru
```

### 建议配置
根据使用场景调整 `maxmemory`:

1. **中等使用量**: `--maxmemory 32gb --maxmemory-policy allkeys-lru`
2. **高使用量**: `--maxmemory 200gb --maxmemory-policy allkeys-lru`
3. **极高使用量**: `--maxmemory 1tb --maxmemory-policy allkeys-lru`

**注意**: 
- `allkeys-lru` 策略会在内存不足时自动淘汰最久未使用的key
- 即使设置了6个月过期，如果内存不足，LRU策略也会提前淘汰缓存
- 建议监控Redis内存使用情况，根据实际需求调整

## 自动清理机制

系统已实现自动清理机制，满足以下任一条件时自动清理缓存：

### 清理条件
1. **缓存大小超过10GB**: 自动删除最旧的缓存，直到大小降至10GB以下
2. **缓存时间超过3个月**: 自动删除所有超过3个月的缓存

### 清理策略
- **定期执行**: 每6小时自动执行一次清理任务
- **年龄清理**: 优先删除超过3个月的缓存
- **大小清理**: 如果总大小超过10GB，按时间顺序删除最旧的缓存（TTL最小的优先）
- **非阻塞**: 使用Redis SCAN命令，避免阻塞Redis服务

### 配置参数
- `RETRIEVAL_CACHE_EXPIRY`: 180天（6个月）- 缓存过期时间
- `RETRIEVAL_CACHE_MAX_SIZE`: 10GB - 最大缓存大小限制
- `RETRIEVAL_CACHE_MAX_AGE`: 90天（3个月）- 最大缓存年龄限制
- 清理任务执行间隔: 6小时

## 优化建议

1. **按需调整过期时间**: 如果内存紧张，可以缩短过期时间
2. **限制page_size**: 对于大page_size的查询，考虑不缓存或缩短过期时间
3. **压缩存储**: 可以考虑对缓存值进行压缩（gzip），可节省50-70%空间
4. **分层缓存**: 
   - 热数据（最近1周）: 完整缓存
   - 冷数据（1周-6个月）: 压缩缓存或只缓存关键字段
5. **监控清理日志**: 定期检查清理日志，了解缓存使用情况

## 监控指标

建议监控以下指标：
- Redis内存使用率
- 缓存命中率
- 缓存key数量
- 平均缓存大小
- 缓存淘汰频率

